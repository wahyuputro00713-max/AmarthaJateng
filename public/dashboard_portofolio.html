<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
  
  <style>
    :root {
      --primary-color: #6f42c1; /* Warna Ungu */
      --secondary-color: #5a32a3;
    }
    body { background-color: #f4f6f9; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    /* Navbar Styling */
    .navbar { background-color: var(--primary-color); box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .navbar-brand { color: white !important; font-weight: bold; }
    
    /* Card Styling */
    .kpi-card { border: none; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: transform 0.2s; }
    .kpi-card:hover { transform: translateY(-3px); }
    .icon-box { font-size: 2rem; opacity: 0.8; }
    
    /* Table Styling */
    .table-header-group { background-color: var(--primary-color); color: white; text-align: center; }
    .sub-header-gl { background-color: #e0cffc; color: #4a0072; text-align: center; font-size: 0.9rem; }
    .sub-header-modal { background-color: #cffcd4; color: #004d1a; text-align: center; font-size: 0.9rem; }
    
    /* Custom Text Colors */
    .text-purple { color: var(--primary-color); }
    .text-npl-high { color: #dc3545; font-weight: bold; } /* Merah */
    .text-npl-low { color: #198754; font-weight: bold; } /* Hijau */
  </style>
</head>
<body>

  <nav class="navbar navbar-expand-lg mb-4">
    <div class="container-fluid">
      <a class="navbar-brand" href="#">üìä Dashboard Portofolio Area</a>
      <span class="text-white">Analysis Tool</span>
    </div>
  </nav>

  <div class="container-fluid px-4">
    <div class="row my-4">
  <div class="col-md-4">
    <label for="filter-area" class="form-label fw-bold">Pilih Area:</label>
    <select id="filter-area" class="form-select shadow-sm">
      <option value="all">Semua Area</option>
      </select>
  </div>
</div>
    
    <div id="loading" class="text-center my-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Sedang memuat data dari Spreadsheet...</p>
    </div>

    <div id="main-content" style="display:none;">
      
      <div class="row g-3 mb-4">
        <div class="col-md-3">
          <div class="card kpi-card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="text-muted mb-1">Total Mitra (All)</p>
                <h3 class="fw-bold" id="kpi-total-mitra">0</h3>
              </div>
              <div class="icon-box text-purple">üë•</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card kpi-card p-3">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="text-muted mb-1">Total Outstanding</p>
                <h4 class="fw-bold" id="kpi-os-total">Rp 0</h4>
              </div>
              <div class="icon-box text-success">üí∞</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card kpi-card p-3 border-start border-4 border-danger">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="text-muted mb-1">Avg NPL GL</p>
                <h3 class="fw-bold text-danger" id="kpi-npl-gl">0%</h3>
              </div>
              <div class="icon-box">üìâ</div>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card kpi-card p-3 border-start border-4 border-warning">
            <div class="d-flex justify-content-between align-items-center">
              <div>
                <p class="text-muted mb-1">Avg NPL Modal</p>
                <h3 class="fw-bold text-warning" id="kpi-npl-modal">0%</h3>
              </div>
              <div class="icon-box">‚ö†Ô∏è</div>
            </div>
          </div>
        </div>
      </div>

      <div class="row g-3 mb-4">
        <div class="col-md-8">
          <div class="card shadow-sm">
            <div class="card-header bg-white fw-bold">Perbandingan NPL: GL vs Modal per Cabang</div>
            <div class="card-body">
              <canvas id="nplChart" height="120"></canvas>
            </div>
          </div>
        </div>
        <div class="col-md-4">
          <div class="card shadow-sm h-100">
            <div class="card-header bg-white fw-bold">Komposisi Mitra (Volume)</div>
            <div class="card-body d-flex justify-content-center align-items-center">
              <canvas id="compositionChart"></canvas>
            </div>
          </div>
        </div>
      </div>

      <div class="card shadow-sm">
        <div class="card-header bg-white">
          <ul class="nav nav-tabs card-header-tabs" id="myTab" role="tablist">
            <li class="nav-item">
              <button class="nav-link active" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail-pane" type="button">Detail Gabungan</button>
            </li>
          </ul>
        </div>
        <div class="card-body">
          <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="detail-pane" role="tabpanel">
              <div class="table-responsive">
                <table id="portfolioTable" class="table table-bordered table-hover w-100">
                  <thead>
                    <tr>
                      <th rowspan="2" class="align-middle bg-light">Cabang</th>
                      <th colspan="3" class="sub-header-gl">PRODUK GL</th>
                      <th colspan="3" class="sub-header-modal">PRODUK MODAL</th>
                    </tr>
                    <tr>
                      <th class="text-center bg-light">Total Mitra</th>
                      <th class="text-center bg-light">DPD 90+</th>
                      <th class="text-center bg-light">% NPL</th>
                      <th class="text-center bg-light">Total Mitra</th>
                      <th class="text-center bg-light">DPD 90+</th>
                      <th class="text-center bg-light">% NPL</th>
                    </tr>
                  </thead>
                  <tbody id="table-body">
                    </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div> </div>

  <script src="https://code.jquery.com/jquery-3.7.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>

  <script>
// ... kode HTML di atas tetap sama ...
    // ==========================================
    // ‚öôÔ∏è KONFIGURASI
    // ==========================================
    // Ganti dengan URL Script Anda jika pakai GitHub Pages (Jika host di GAS, biarkan kosong)
    const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyv0yz4eE-kq5pUIhJMyP52pmX5-dfvpC3GvkBrhqE1qjgXV1mes4gpGu8mpD_OBLnm/exec"; 

    // Konfigurasi Kolom Excel (Index dimulai dari 0: A=0, B=1, C=2...)
    const COL = {
      AREA: 2,           // <--- TAMBAHAN BARU: Kolom Area (Cek excel anda, misal Kolom C = 2)
      BRANCH: 3,         // Kolom Nama Cabang
      GL_MITRA: 7,       // Kolom Total Mitra GL
      GL_DPD90: 13,      // Kolom Macet GL
      MODAL_MITRA: 8,   // Kolom Total Mitra Modal
      MODAL_DPD90: 18    // Kolom Macet Modal
    };

    // Variabel Global untuk menyimpan data mentah
    let rawData = []; 

    // ==========================================
    // LOGIC UTAMA
    // ==========================================
    
    $(document).ready(function() {
      // Cek apakah host di Google Script atau GitHub
      if (window.location.hostname.includes("googleusercontent")) {
        // Mode Hosting di Google Script
        google.script.run.withSuccessHandler(initDashboard).getData();
      } else {
        // Mode Hosting di GitHub/External (Pakai Fetch)
        fetch(APPS_SCRIPT_URL)
          .then(res => res.json())
          .then(data => initDashboard(data))
          .catch(e => alert("Gagal ambil data: " + e));
      }

      // Event Listener: Saat Filter Berubah
      $('#filter-area').on('change', function() {
        let selectedArea = $(this).val();
        renderDashboard(selectedArea); // Gambar ulang dashboard
      });
    });

    // Fungsi Inisialisasi Awal
    function initDashboard(response) {
      if (response.status === 'error') {
        alert('Error: ' + response.message);
        return;
      }

      // 1. Simpan data mentah ke variabel global
      rawData = response.data;

      // 2. Isi Dropdown Filter Area secara otomatis
      populateFilterArea();

      // 3. Render Dashboard pertama kali (Tampilkan Semua)
      $('#loading').hide();
      $('#main-content').fadeIn();
      renderDashboard('all');
    }

    // Fungsi Mengisi Dropdown Area (Ambil nama area unik)
    function populateFilterArea() {
      let uniqueAreas = [...new Set(rawData.map(row => row[COL.AREA]))].sort();
      
      uniqueAreas.forEach(area => {
        if(area) { // Cek agar tidak ada area kosong
            $('#filter-area').append(`<option value="${area}">${area}</option>`);
        }
      });
    }

    // Fungsi Utama: Menggambar Ulang Dashboard (KPI, Tabel, Grafik)
    function renderDashboard(filterValue) {
      const tableBody = $('#table-body');
      tableBody.empty(); // Kosongkan tabel sebelum diisi ulang
      
      // Hancurkan Chart lama jika ada (agar tidak menumpuk)
      if (window.chartNPL instanceof Chart) window.chartNPL.destroy();
      if (window.chartComp instanceof Chart) window.chartComp.destroy();
      // Hancurkan DataTable lama jika ada
      if ($.fn.DataTable.isDataTable('#portfolioTable')) {
          $('#portfolioTable').DataTable().destroy();
      }

      // --- FILTER DATA ---
      let filteredRows = rawData;
      if (filterValue !== 'all') {
        filteredRows = rawData.filter(row => row[COL.AREA] === filterValue);
      }

      // --- VARIABEL AGREGAT ---
      let labels = [];
      let dataNplGL = [];
      let dataNplModal = [];
      let totalMitraGL = 0;
      let totalMitraModal = 0;
      let totalMacetGL = 0;
      let totalMacetModal = 0;

      // --- LOOP DATA TERFILTER ---
      filteredRows.forEach(row => {
        let branch = row[COL.BRANCH];
        let glMitra = parseNumber(row[COL.GL_MITRA]);
        let glMacet = parseNumber(row[COL.GL_DPD90]);
        let modalMitra = parseNumber(row[COL.MODAL_MITRA]);
        let modalMacet = parseNumber(row[COL.MODAL_DPD90]);

        // Hitung NPL
        let glNpl = (glMitra > 0) ? ((glMacet / glMitra) * 100).toFixed(2) : 0;
        let modalNpl = (modalMitra > 0) ? ((modalMacet / modalMitra) * 100).toFixed(2) : 0;

        // Akumulasi KPI
        totalMitraGL += glMitra;
        totalMitraModal += modalMitra;
        totalMacetGL += glMacet;
        totalMacetModal += modalMacet;

        // Data Chart
        labels.push(branch);
        dataNplGL.push(glNpl);
        dataNplModal.push(modalNpl);

        // Render Tabel HTML
        let html = `
          <tr>
            <td class="fw-bold">${branch}</td>
            <td class="text-end">${formatRibuan(glMitra)}</td>
            <td class="text-end">${formatRibuan(glMacet)}</td>
            <td class="text-end ${getColorClass(glNpl)}">${glNpl}%</td>
            <td class="text-end">${formatRibuan(modalMitra)}</td>
            <td class="text-end">${formatRibuan(modalMacet)}</td>
            <td class="text-end ${getColorClass(modalNpl)}">${modalNpl}%</td>
          </tr>
        `;
        tableBody.append(html);
      });

      // --- UPDATE KPI CARDS ---
      $('#kpi-total-mitra').text(formatRibuan(totalMitraGL + totalMitraModal));
      
      let avgNplGL = (totalMitraGL > 0) ? ((totalMacetGL / totalMitraGL) * 100).toFixed(2) : 0;
      let avgNplModal = (totalMitraModal > 0) ? ((totalMacetModal / totalMitraModal) * 100).toFixed(2) : 0;
      
      $('#kpi-npl-gl').text(avgNplGL + "%");
      $('#kpi-npl-modal').text(avgNplModal + "%");

      // --- RE-INIT DATATABLE ---
      $('#portfolioTable').DataTable({
        "pageLength": 10,
        "order": [[ 3, "desc" ]] 
      });

      // --- RENDER CHARTS ---
      renderNplChart(labels, dataNplGL, dataNplModal);
      renderCompositionChart(totalMitraGL, totalMitraModal);
    }

    // --- HELPER FUNCTIONS ---
    function parseNumber(str) {
      if (!str) return 0;
      let cleanStr = str.toString().replace(/\./g, "").replace(/,/g, "."); 
      return parseFloat(cleanStr) || 0;
    }

    function formatRibuan(num) {
      return num.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
    }

    function getColorClass(nplValue) {
      if (nplValue > 5) return 'text-npl-high'; 
      if (nplValue < 2) return 'text-npl-low';  
      return 'text-warning';                    
    }

    // --- CHART FUNCTIONS (DISIMPAN KE WINDOW AGAR BISA DIDESTROY) ---
    function renderNplChart(labels, glData, modalData) {
      const ctx = document.getElementById('nplChart').getContext('2d');
      window.chartNPL = new Chart(ctx, { // Simpan ke variabel global window
        type: 'bar',
        data: {
          labels: labels,
          datasets: [
            { label: 'NPL GL (%)', data: glData, backgroundColor: 'rgba(54, 162, 235, 0.7)' },
            { label: 'NPL Modal (%)', data: modalData, backgroundColor: 'rgba(153, 102, 255, 0.7)' }
          ]
        },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderCompositionChart(glTotal, modalTotal) {
      const ctx = document.getElementById('compositionChart').getContext('2d');
      window.chartComp = new Chart(ctx, { // Simpan ke variabel global window
        type: 'doughnut',
        data: {
          labels: ['Mitra GL', 'Mitra Modal'],
          datasets: [{
            data: [glTotal, modalTotal],
            backgroundColor: ['#36a2eb', '#9966ff'],
            hoverOffset: 4
          }]
        },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom' } } }
      });
    }
  </script>
</body>
</html>
